<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>

    <script>

        function remove(li, id) {
            $.ajax({
                url: "http://localhost:8080/api/v1/emergenze/" + id,
                type: 'PUT',
                data: '',

                success: function (result) {
                    document.getElementById("notif_ul").innerHTML = "";
                    json = JSON.parse(result);
                    for (let i = 0; i < json.length; i++) {
                        document.getElementById("notif_ul").innerHTML += "<li onclick=\"remove(this," + json[i]['id'] + ")\" id=\""+ json[i]['id'] +"\">" + json[i]["code"] + " - Room: " + json[i]["room"]['name'] + "</li>";
                    }
                    if (document.getElementById("notif_ul").getElementsByTagName("li").length > 0)
                        document.getElementById('notif_div').classList.add('notification');
                    else {
                        document.getElementById('notif_div').classList.remove('notification');
                    }
                    location.reload(true);

                },
                cache: false

            });
            document.getElementById("notif_ul").removeChild(li);
            if (document.getElementById("notif_ul").getElementsByTagName("li").length > 0)
                document.getElementById('notif_div').classList.add('notification');
            else {
                document.getElementById('notif_div').classList.remove('notification');
            }
        }



        function notification(json) {
            document.getElementById("notif_ul").innerHTML = "";

            if (json.length > 0){
                document.getElementById("notif_div").innerHTML += "<label style='color: red; font-weight: bold'>Ci snono nuove notifiche</label>";
            }
            else {
                document.getElementById("notif_div").innerHTML += "Nessuna notifica";
            }

            for (let i = 0; i < json.length; i++) {
                document.getElementById("notif_ul").innerHTML += "<li onclick=\"remove(this," + json[i]['id'] + ")\" id=\""+ json[i]['id'] +"\">" + json[i]["code"] + " - Room: " + json[i]["room"]['name'] + "</li>";
            }
            if (document.getElementById("notif_ul").getElementsByTagName("li").length > 0)
                document.getElementById('notif_div').classList.add('notification');
            else {
                document.getElementById('notif_div').classList.remove('notification');
                document.getElementById("notif_ul").innerHTML = "<li><a class=\"dropdown-item text-black-50\">No new events</a></li>";
            }
        }


        $(document).ready(function () {
            /*$.ajaxSetup({
                headers: {"X-CSRFToken": getCookie("csrftoken")},
            });*/

            $("#btn-create-room").click(function(){
                let text='{"room":'+$("#text-create-room").val()+'}';
                $.ajax({
                    type:'POST',
                    url:'http://localhost:8080/api/v1/rooms',
                    contentType:'application/json',
                    dataType: 'json',
                    data: '"'+$("#text-create-room").val()+'"',

                    success : function(data){
                        var toastLiveExample = document.getElementById('create-room-toast')
                        var toast = new bootstrap.Toast(toastLiveExample)
                        toast.show()
                    }

                });
            });



            $(".btn-del-room").click(function(){

                let room = this.attr("value");
                const roomArr = text.split("-");
                $.ajax({
                    type: 'DELETE',
                    url: 'http://localhost:8080/api/v1/rooms/' + roomArr[1],
                    contentType: "application/json",
                    dataType: "json",
                    
                    success: function (data) {
                        var toastLiveExample = document.getElementById('delete-room-toast')
                        var toast = new bootstrap.Toast(toastLiveExample)
                        toast.show()
                    }

                })
            });

            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/api/v1/devices',
                contentType: "application/json",
                dataType: "json",

                success: function (data) {
                    var result = JSON.parse(JSON.stringify(data));

                    let devices = data;
                    for (let i = 0; i < devices.length; i++) {
                        console.log(devices[i].id);
                        $('#sub-devices').append(
                            '<div class="col-md-4">'+
                            '<div class="card">  ' +
                            '	<div class="card-body">' +
                            '<h5 class="card-title">' + devices[i].label + '</h5>    ' +
                            '<h6 class="card-subtitle mb-2 text-muted"> Category: ' + devices[i].category + '</h6>   ' +
                            '<p class="card-text">' + devices[i].room.name + '</p>' +
                            '<a href="#" class="card-link">Card link</a>    <a href="#" class="card-link">Another link</a>  </div></div></div>');
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    var errorMsg = 'Ajax request failed: ' + xhr.responseText;
                    $('#content').html(errorMsg);
                }
            });

            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/api/v1/rooms',
                contentType: "application/json",
                dataType: "json",

                success: function (data) {
                    var result = JSON.parse(JSON.stringify(data));

                    let rooms = data;
                    for (let i = 0; i < rooms.length; i++) {
                        console.log(rooms[i].id);
                        $('#sub-rooms').append(
                            '<div class="col-md-4">'+
                            '<div class="card">  ' +
                            '	<div class="card-body">' +
                            '<h5 class="card-title">' + rooms[i].name + '</h5>' +
                            '<button id="btn-del-room" value="'+rooms[i].id+'" name="btn-del-room" type="button" class="btn btn-danger">Elimina</button></div></div></div>');
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    var errorMsg = 'Ajax request failed: ' + xhr.responseText;
                    $('#content').html(errorMsg);
                }
            });
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/api/v1/users',
                contentType: "application/json",
                dataType: "json",

                success: function (data) {
                    var result = JSON.parse(JSON.stringify(data));

                    let users = data;
                    for (let i = 0; i < users.length; i++) {
                        console.log(users[i].id);
                        $('#sub-users').append(
                            '<div class="col-md-4">'+
                            '<div class="card">  ' +
                            '	<div class="card-body">' +
                            '<h5 class="card-title">' + users[i].name + '</h5>' +
                            '<h6 class="card-subtitle mb-2 text-muted">' + users[i].email + '</h6>   ' +
                            '<button type="button" class="btn btn-danger">Elimina</button></div></div></div>');
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {

                    var errorMsg = 'Ajax request failed: ' + xhr.responseText;
                    $('#content').html(errorMsg);
                }
            });

            function getCookie(c_name) {
                if (document.cookie.length > 0) {
                    c_start = document.cookie.indexOf(c_name + "=");
                    if (c_start != -1) {
                        c_start = c_start + c_name.length + 1;
                        c_end = document.cookie.indexOf(";", c_start);
                        if (c_end == -1) c_end = document.cookie.length;
                        return unescape(document.cookie.substring(c_start, c_end));
                    }
                }
                return "";
            }


            $.ajax({
                url: "http://localhost:8080/api/v1/emergenze/pending",
                type: 'GET',
                data: '',

                success: function (result) {
                    json = JSON.parse(JSON.stringify(result));
                    notification(json);
                },
                cache: false
            });

            setInterval(function () {
                $.ajax({
                    url: "http://localhost:8080/api/v1/emergenze/pending",
                    type: 'GET',
                    data: '',

                    success: function (result) {
                        json = JSON.parse(result);
                        notification(json);

                    },
                    cache: false
                });
            }, 20000);


        });

    </script>


</head>
<body>
<div class="container-lg">

    <div>
        <ul class="nav justify-content-center">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#devices">Devices</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#rooms">Rooms</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="users">Users</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled">Preferences</a>
            </li>

            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="d-none d-lg-block d-xl-block" id="notif_div"></div>


                </a>
                <ul class="dropdown-menu dropdown-menu-right dropdown-navbar" id="notif_ul" aria-labelledby="navbarDropdownMenuLink">

                </ul>
            </li>


        </ul>
    </div>
    <h1>Smart Home Service</h1>

    <div class="container-lg" id="devices">
        <h2>My devices</h2>
        <div class="row" id="sub-devices">

        </div>

    </div>

    <br>

    <div class="container" id="rooms">
        <h2>My rooms</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#room-modal" data-bs-whatever="@fat">Nuova stanza</button>
        <div class="modal fade" id="room-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Inserire nuova stanza</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label for="recipient-name" class="col-form-label">Nome:</label>
                      <input type="text" class="form-control" id="text-create-room">
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="btn-create-room">Send message</button>
                </div>
              </div>
            </div>
          </div>
        <div class="row" id="sub-rooms">

        </div>
    </div>

    <br>

    <div class="container" id="users">
        <h2>Users</h2>
        <div class="row" id="sub-users">

        </div>
    </div>

    <br>

    <div class="container" id="preferences">
        <h2>My preferences</h2>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="delete-room-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
        Stanza eliminata con successo
        </div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>


    <div id="create-room-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
            Stanza creata con successo
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>


<script>

</script>


</body>
</html>